name: AutoFetchAndMergeIPTV

on:
  schedule:
    - cron: '*/6 * * * *'           # â° æ¯6åˆ†é’Ÿè‡ªåŠ¨è¿è¡Œï¼ˆUTCæ—¶é—´ï¼‰
  push:                              # ðŸ“ æœ‰æ›´æ”¹æ—¶è‡ªåŠ¨è§¦å‘
    paths:
      - '*.m3u'
      - 'README.md'
      - '.github/workflows/**'
  workflow_dispatch:                 # ðŸ–ï¸ å…è®¸æ‰‹åŠ¨å¯åŠ¨

env:
  TZ: Asia/Kuala_Lumpur              # è®¾ç½®ä¸ºé©¬æ¥è¥¿äºšæ—¶é—´

jobs:
  fetch_merge:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        persist-credentials: false

    - name: Get current time (MYT)
      run: echo "GET_TIME=$(date +'%Y-%m-%d %H:%M:%S MYT')" >> $GITHUB_ENV

    - name: Download and Merge M3U Files (always rebuild)
      run: |
        LINKS=(
          "https://raw.githubusercontent.com/kfwong15/ABC/main/owntv"
        )

        echo "#EXTM3U" > ALL_IPTV.m3u

        for URL in "${LINKS[@]}"; do
          FILE_NAME=$(echo "$URL" | sed 's|https://raw.githubusercontent.com/||' | sed 's|/|_|g').m3u
          echo "ðŸ“¥ æ­£åœ¨ä¸‹è½½ï¼š$URL"
          wget -q "${URL}?t=$(date +%s)" -O "$FILE_NAME"

          if [ -s "$FILE_NAME" ]; then
            grep -q "^#EXTM3U" "$FILE_NAME" || sed -i '1i #EXTM3U' "$FILE_NAME"
            tail -n +2 "$FILE_NAME" >> ALL_IPTV.m3u
          else
            echo "âŒ æ–‡ä»¶ä¸ºç©ºæˆ–ä¸‹è½½å¤±è´¥ï¼š$FILE_NAME"
          fi
        done

        VALID_CHANNELS=$(grep -c '^#EXTINF' ALL_IPTV.m3u)
        echo "é¢‘é“æ€»æ•°ï¼š$VALID_CHANNELS"

        # å¼ºåˆ¶åˆ¶é€ å˜åŒ–ï¼šæ·»åŠ å½“å‰æ—¶é—´
        echo "# æ›´æ–°æ—¶é—´ ${GET_TIME}" >> ALL_IPTV.m3u

        echo "Auto update at ${GET_TIME}" > README.md
        echo "é¢‘é“æ€»æ•°ï¼š$VALID_CHANNELS" >> README.md

    - name: Force Commit and Push Every Run
      run: |
        git config --global user.name "kfwong15"
        git config --global user.email "kfwong15@users.noreply.github.com"

        git add -A
        git commit -m "ðŸ”„ Forced update at ${GET_TIME}" --allow-empty
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
        git push
