name: AutoFetchAndMergeEPG

on:
  schedule:
    - cron: '*/6 * * * *'
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/**'
      - 'README.md'

env:
  TZ: Asia/Kuala_Lumpur

jobs:
  fetch_merge_epg:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        persist-credentials: false

    - name: Get current time
      run: echo "GET_TIME=$(date +'%Y-%m-%d %H:%M:%S MYT')" >> $GITHUB_ENV

    - name: Download and Merge EPG XMLs
      run: |
        EPG_LINKS=(
          "https://epgshare01.online/epgshare01/epg_ripper_ALL_SOURCES1.xml.gz"
        )

        echo "üì• Ê≠£Âú®‰∏ãËΩΩÂπ∂ÂêàÂπ∂ EPG Êñá‰ª∂..."

        > epg.xml
        echo '<?xml version="1.0" encoding="UTF-8"?>' >> epg.xml
        echo '<tv>' >> epg.xml

        for URL in "${EPG_LINKS[@]}"; do
          echo "üîó ‰∏ãËΩΩÔºö$URL"
          curl -s --fail --max-time 30 "$URL" -o temp_epg.xml.gz || continue

          if [ -s temp_epg.xml.gz ]; then
            gunzip -c temp_epg.xml.gz > temp_epg.xml || continue

            if grep -q "<channel" temp_epg.xml; then
              echo "‚úÖ ÊàêÂäüÂπ∂ÊúâÂÜÖÂÆπÔºö$URL"
              sed '/<\?xml/d;/<tv>/d;/<\/tv>/d' temp_epg.xml >> epg.xml
            else
              echo "‚ö†Ô∏è EPG ÂÜÖÂÆπ‰∏∫Á©∫Ôºö$URL"
            fi
          else
            echo "‚ö†Ô∏è ‰∏ãËΩΩÂ§±Ë¥•ÊàñÊñá‰ª∂‰∏∫Á©∫Ôºö$URL"
          fi
        done

        echo '</tv>' >> epg.xml
        rm -f temp_epg.xml temp_epg.xml.gz

        SIZE=$(du -h epg.xml | cut -f1)
        echo "EPG_SIZE=${SIZE}" >> $GITHUB_ENV
        echo "‚úÖ ÂêàÂπ∂ÂÆåÊàêÔºåEPG Êñá‰ª∂Â§ßÂ∞èÔºö$SIZE"

    - name: Update README
      run: |
        echo "üì° EPG Ëá™Âä®Êõ¥Êñ∞" > README.md
        echo "" >> README.md
        echo "- Êõ¥Êñ∞Êó∂Èó¥ÔºàMYTÔºâÔºö${GET_TIME}" >> README.md
        echo "- ÂêàÂπ∂Êñá‰ª∂Â§ßÂ∞èÔºö${EPG_SIZE}" >> README.md

    - name: Commit and Push (force)
      run: |
        git config --global user.name "kfwong15"
        git config --global user.email "kfwong15@users.noreply.github.com"

        git add -A
        git commit -m "üì° ÂêàÂπ∂ EPG Êõ¥Êñ∞‰∫é ${GET_TIME}" --allow-empty

        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

        git push --force
