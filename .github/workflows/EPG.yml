name: AutoFetchEPG

on:
  schedule:
    - cron: '*/6 * * * *'           # ⏰ 每6分钟自动运行（UTC时间）
  workflow_dispatch:                 # 🖐️ 允许手动触发

env:
  TZ: Asia/Kuala_Lumpur              # 设置为马来西亚时间

jobs:
  fetch_epg:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        persist-credentials: false

    - name: Get current time (MYT)
      run: echo "GET_TIME=$(date +'%Y-%m-%d %H:%M:%S MYT')" >> $GITHUB_ENV

    - name: Download EPG XML
      run: |
        EPG_URL="https://iptv-org.github.io/epg/guides/zh.xml"   # ⛳ 请将此处改成你的EPG源URL

        echo "📥 正在下载 EPG：$EPG_URL"
        wget -q "${EPG_URL}?t=$(date +%s)" -O epg.xml

        if [ -s epg.xml ]; then
          echo "✅ 成功下载 epg.xml"
        else
          echo "❌ EPG 下载失败或文件为空"
          exit 1
        fi

        echo "EPG 最后更新时间：${GET_TIME}" > README.md

    - name: Commit and Push
      run: |
        git config --global user.name "kfwong15"
        git config --global user.email "kfwong15@users.noreply.github.com"
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

        git add epg.xml README.md
        git commit -m "🕒 EPG 更新于 ${GET_TIME}" --allow-empty
        git pull --rebase
        git push
