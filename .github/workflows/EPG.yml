name: AutoFetchEPG

on:
  schedule:
    - cron: '*/6 * * * *'           # â° æ¯6åˆ†é’Ÿè‡ªåŠ¨è¿è¡Œï¼ˆUTCæ—¶é—´ï¼‰
  workflow_dispatch:                 # ðŸ–ï¸ å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  TZ: Asia/Kuala_Lumpur              # è®¾ç½®ä¸ºé©¬æ¥è¥¿äºšæ—¶é—´

jobs:
  fetch_epg:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        persist-credentials: false

    - name: Get current time (MYT)
      run: echo "GET_TIME=$(date +'%Y-%m-%d %H:%M:%S MYT')" >> $GITHUB_ENV

    - name: Download EPG XML
      run: |
        EPG_URL="https://iptv-org.github.io/epg/guides/zh.xml"   # â›³ è¯·å°†æ­¤å¤„æ”¹æˆä½ çš„EPGæºURL

        echo "ðŸ“¥ æ­£åœ¨ä¸‹è½½ EPGï¼š$EPG_URL"
        wget -q "${EPG_URL}?t=$(date +%s)" -O epg.xml

        if [ -s epg.xml ]; then
          echo "âœ… æˆåŠŸä¸‹è½½ epg.xml"
        else
          echo "âŒ EPG ä¸‹è½½å¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©º"
          exit 1
        fi

        echo "EPG æœ€åŽæ›´æ–°æ—¶é—´ï¼š${GET_TIME}" > README.md

    - name: Commit and Push
      run: |
        git config --global user.name "kfwong15"
        git config --global user.email "kfwong15@users.noreply.github.com"
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

        git add epg.xml README.md
        git commit -m "ðŸ•’ EPG æ›´æ–°äºŽ ${GET_TIME}" --allow-empty
        git pull --rebase
        git push
